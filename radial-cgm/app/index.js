import e from"clock";import t from"document";import{me as n}from"appbit";import{me as l}from"device";import*as msg from"messaging";import*as util from"../common/utils";import{readFileSync as i}from"fs";import{writeFileSync as o}from"fs";import{unlinkSync as a}from"fs";import{statSync as s}from"fs";import{vibration as r}from"haptics";import m from"./graph.js";import{inbox as d}from"file-transfer";import{display as c}from"display";import{memory as y}from"system";import{charger as u}from"power";let g=[300,300];function p(){return"mmol/L"===le?util.oneDecimal(util.mmol(ie)):ie}function f(e){return"mmol/L"===le?util.mmol(e):e}function h(e){return"mmol/L"===le?util.mgdl(e):e}y.monitor.onmemorypressurechange=function(){switch(y.monitor.pressure){case"normal":case"high":P.r=10;break;case"critical":P.r=30}};let B=t.getElementById("noteBG"),I=t.getElementById("noteMess"),b=t.getElementById("noteTime"),k=t.getElementById("dismiss");k.onactivate=Ct;let w=t.getElementById("snooze");w.onactivate=Lt;var T=[],E=[],x=[],$=[];let v=-1,S=0,D=-1;l.screen||(l.screen={width:348,height:250});const G=l.screen.width,z=l.screen.height;import{clockFace as C}from"./clock.js";let H=new C,M=H.appName(),L="radialcgm"==M?1:0,j="orbitsns"==M?1:0;e.granularity=j?"minutes":"seconds";var U=1;let A=t.getElementById("arrow"),N=t.getElementById("circle"),R=t.getElementById("sgv"),O=t.getElementById("sgvbutton"),P=t.getElementById("state"),W=t.getElementById("forceUpdate"),F=0;var Y,_,q,J,K,Q,V;try{_=L?t.getElementById("docGraph"):(q=t.getElementById("graphWindow")).getElementById("docGraph"),Y=new m(_)}catch(e){}function X(){gn=new Date,c.on&&Z&&se<gn.getTime()&&Ke()}W.onclick=function(){try{a("forceExit")}catch(e){}Z&&Ke()},c.addEventListener("change",X);let Z=!1;var ee=[],te=[],ne=[];let le="bg/dl",ie=0,oe=0,ae=0,se=0,re=0,me=0,de=0,ce=0,ye=0,ue=0,ge=0,pe=!1,fe=0,he=0,Be=0,Ie=0,be=0,ke=3,we=12;var Te,Ee,xe,$e;function ve(e){Math.abs(re)>20||fe>0&&Math.abs(f(re))>=fe?e.style.fill="red":e.style.fill=Ze?"yellow":"lightgreen"}function Se(e){return e>0&&p()>e}function De(e){return e>0&&p()<e}const Ge=1*z,ze=.55*z;function Ce(){console.log("Update Corners"),gn=new Date;let e=t.getElementById("month"),n=t.getElementById("date"),l=t.getElementById("hour"),i=t.getElementById("minute");gn.getTime()<F?(e.text=`${$e}`,n.text=`${xe}`,l.text=`${Te}`,i.text=`${util.zeroPad(Ee)}`,e.style.display="inline",n.style.display="inline",l.style.display="inline",i.style.display="inline",A.style.display="none",R.style.display="none",P.style.display="none",N.style.display="none",Vt.style.display="none"):(e.style.display="none",n.style.display="none",l.style.display="none",i.style.display="none",Z&&(He(),P.style.display="inline"),Vt.style.display="inline",F=0)}function He(){if(gn=new Date,Z&&0==F&&0!=oe){R.text=`${p()}`,R.style.fill=Y.setColor(p());let e=gn.getTime()-oe,t=1;(e/=6e4)<5?t=1:(e>5&&(e-=5),(t=(20-e)/20)<0&&(t=0),t>1&&(t=1)),R.style.fillOpacity=t,R.style.display="inline",(ye||ue||ce||ge)&&p()>0&&0==t&&(R.style.fillOpacity=1,R.text=`${Math.floor(e)} mins old`);let n=90*re/20;(n=90-n)<0&&(n=0),n>180&&(n=180),lt>pn?(N.style.display="inline",A.style.display="none",ve(N),pn=gn.getTime()):(N.style.display="none",A.style.display="inline",A.groupTransform.rotate.angle=n,ve(A),A.style.opacity=t),Me()}}function Me(){P.style.fill=Oe>0?"red":0==Oe?"green":"white"}function Le(){c.poke(),u.connected?35!=l.modelId&&(e.granularity="seconds"):j&&(e.graularity="minutes")}function je(){gn=new Date,Te=gn.getHours(),Ee=gn.getMinutes(),xe=gn.getDate(),$e=gn.getMonth()+1,H.updateClock(Ge,ze,Be,gn,U),u.connected&&35!=l.modelId&&c.poke()}function Ue(e,t,n){if(!e.def||!t.def)return!1;let l=60*e.hours+e.minutes,i=60*t.hours+t.minutes,o=60*n.getHours()+n.getMinutes();if(l==i)return!1;if(l<i){if(l<o&&o<i)return!0}else{if(o>l)return!0;if(o<i)return!0}return!1}function Ae(e){(0==e||!Ue(Pe,We,e)&&(0==At||At<e.getTime()))&&(kt(g),c.poke())}function Ne(e){var t;try{s("forceExit");t=!0}catch(e){t=!1}if(t)Ae(e);else{o("forceExit",{time:e},"json");s("forceExit");n.exit()}}u.onchange=Le;let Re=0,Oe=-1,Pe={def:!1},We={def:!1};function Fe(e){var t;return gn=new Date,msg.peerSocket.readyState===msg.peerSocket.OPEN?(msg.peerSocket.send({command:e}),Re=gn.getTime(),Oe<0?Oe--:Oe=-1,t=!0):(Oe>0?Oe++:Oe=1,t=!1),Me(),Math.abs(Oe)>10&&(ye>0||ue>0||ce>0||ge>0)&&Ne(gn),t}var Ye=t.getElementById("clicker");function _e(e){let t=new Date(e);if(null==e||isNaN(e))return Be=0,Ie=0,void(be=0);Be=new Date(t.getTime()+24*ke*60*60*1e3-60*we*60*1e3),Ie=Be.getHours(),be=Be.getMinutes()}Ye.onclick=function(e){0==F?(F=(F=new Date).getTime()+5e3,setTimeout(Ce,5e3),Ce()):(F=0,Ce())},e.ontick=(()=>je());let qe=0;function Je(){clearTimeout(qe),Ke()}function Ke(){Z&&(Fe("data")?(qe&&clearTimeout(qe),qe=setTimeout(Je,5e3)):(he&&clearTimeout(he),he=setTimeout(Ke,1e4)))}function Qe(){return gn=new Date,Se(ue)&&gn.getTime()>=rt||De(ye)&&gn.getTime()>=st||Se(ge)&&gn.getTime()>=dt||De(ce)&&gn.getTime()>=mt?Bt():("inline"==ct.style.display&&pt(),"inline"==at.style.display&&(at.style.display="none"),0)}let Ve=0,Xe=0,Ze=!1;function et(e){if(Ze=!1,0==Ve||0==Xe)return;var t;let n=60*Ve*1e3;for(t=0;t<ne.length&&e.getTime()-ne[t]<n;t++)if(lt>=ne[t])return;try{Math.abs(p()-f(te[t]))>Xe&&(Ze=!0,Ae(e))}catch(e){}}function tt(e){1==e?(0==Z&&(Z=!0,Ke()),W.style.display="inline",P.style.display="inline"):(Z=!1,A.style.display="none",R.style.display="none",P.style.display="none",W.style.display="none",N.style.display="none"),He()}function nt(){Se(ce+1)&&(mt=0),Se(ye+1)&&(st=0),De(ge-1)&&(dt=0),De(ue-1)&&(rt=0)}let lt=0;msg.peerSocket.onmessage=(t=>{switch(gn=new Date,t.data.key){case"bg":Oe=0;let n=0;if(t.data.bg>0){ie=t.data.bg,oe=t.data.date,ae=t.data.period,re=t.data.delta;let e=3e5;L&&(e=6e5),oe-ne[0]>=e&&(n=1,te.unshift(ie),ne.unshift(oe))}for(;ne.length>0&&(ne.length>Y.maxBGs()||ne[ne.length-1]<gn.getTime()-396e5);)n=1,te.pop(),ne.pop()>lt&&(lt=0);gn.getTime()-oe>=12e5&&(ye||ue||ce||ge)?Ae(gn):(nt(),fe>0&&Math.abs(f(re))>=fe?Ae(gn):!Qe()&&ie<=40?Ae(0):et(gn),n&&(Tt&&Jt(te,ne),L&&Y.updateRgraph(te,ne,z,G,lt))),t.data.update>0&&(se=t.data.update,he&&clearTimeout(he),he=setTimeout(Ke,se-gn.getTime())),tt(1);break;case"ack":Oe=0,qe&&(clearTimeout(qe),qe=0),Me();break;case"podchange":let l=parseInt(t.data.value);ke=parseInt(t.data.period),we=parseInt(t.data.before),_e(l),o("podchange",{podchange:l,period:ke,before:we},"json");break;case"alarm":Ot(t.data.number,t.data.value);break;case"mess":Wt(t.data.number,t.data.value);break;case"alarmsnooze":fn[t.data.number]=parseInt(t.data.value),o("alarmSnooze",fn,"json");break;case"timer":ot(t.data.number);break;case"limits":let i=t.data.UL,a=t.data.L,s=t.data.H,r=t.data.UH,m=t.data.diff;Y.setUL(h(i)),Y.setL(h(a)),Y.setH(h(s)),Y.setUH(h(r)),ce=i,ye=a,ue=s,ge=r,fe=m,Y.setULC(t.data.ULC),Y.setLC(t.data.LC),Y.setUHC(t.data.UHC),Y.setHC(t.data.HC),Y.setIRC(t.data.IRC),Y.updateRgraph(te,ne,z,G,lt),ut(),Qe();break;case"long":Ve=t.data.period,Xe=t.data.diff;break;case"cal":lt=t.data.number;break;case"warn-start":if(""==t.data.value)Pe={def:!1};else{let e=t.data.value.split(":");Pe={hours:parseInt(e[0]),minutes:parseInt(e[1]),def:!0}}o("warn-start",Pe,"json");break;case"warn-end":if(""==t.data.value)We={def:!1};else{let e=t.data.value.split(":");We={hours:parseInt(e[0]),minutes:parseInt(e[1]),def:!0}}o("warn-end",We,"json");break;case"units":le=t.data.value,Qe();break;case"bgFont1":R.style.fontSize=t.data.number;break;case"bgsnooze":Bn[t.data.number]=parseInt(t.data.value),o("BGSnooze",Bn,"json");break;case"defBgSz":In=t.data.number;break;case"defAlmSz":hn=t.data.number;break;case"ns":o("ns",{nsconfigured:t.data.number},"json"),tt(t.data.number);break;case"graphdata":let d=t.data.data;for(let e=0;e<t.data.data.length;e++)te[e]=d[e].s,ne[e]=d[e].d;setTimeout(function(){},0),Tt&&Jt(te,ne);break;case"gradient":H.setGradColor(t.data.value);break;case"hour":H.setHourColor(t.data.value);break;case"minute":H.setMinColor(t.data.value);break;case"second":H.setSecColor(t.data.value);break;case"iobcob":me=t.data.iob,de=t.data.cob,J.text=`${me}`,K.text=`${de}`;break;case"urgent":pe=t.data.number,Qe();break;case"message":k.style.display="inline",B.style.fill="white",I.onclick=Ct,$t(t.data.value,!0);break;case"seconds":U=t.data.number,console.log(`Storing displaySeconds as ${U}`),e.granularity=1==U?"seconds":"minutes",je()}try{a("forceExit")}catch(e){}});let it=t.getElementById("timerWindow");function ot(e){let t=it.getElementById("timer"),n=0,l=0;l=60*e,n=setInterval(function(){let e=Math.floor(l/60),i=l-60*e;if(t.text=`${util.zeroPad(e)}:${util.zeroPad(i)}`,--l<0)return l=0,clearInterval(n),it.style.display="none",void kt(g);l<5&&r.start("bump"),it.style.display="inline",c.poke()},1e3)}msg.peerSocket.onopen=(e=>{Z&&Ke()});let at=t.getElementById("snoozeTimes"),st=0,rt=0,mt=0,dt=0,ct=t.getElementById("BGgraph");ct.onactivate=xt;let yt=t.getElementById("suppress");function ut(){o("BGLimits",{BGUL:ce,BGLow:ye,BGHigh:ue,BGUH:ge,LS:st,HS:rt,ULS:mt,UHS:dt,BGDiff:fe},"json")}function gt(e){console.log(`BG Snooze for ${e} minutes`),at.style.display="none",gn=new Date,De(ce)?(mt=gn.getTime()+6e4*e,st=mt):Se(ge)?(dt=gn.getTime()+6e4*e,rt=dt):Se(ue)?rt=gn.getTime()+6e4*e:De(ye)&&(st=gn.getTime()+6e4*e),ut()}function pt(){console.log("Dismiss function here ********"),I.style.display="none",B.style.display="none",b.style.display="none",yt.style.display="none",ct.style.display="none",r.stop(),clearTimeout(S),Qt(2)}function ft(){pt();try{let e=i("BGSnooze","json");for(let t=0;t<8;t++)e[t]&&(Bn[t]=e[t])}catch(e){}for(let e=0;e<8;e++){let t=at.getElementById(e.toString());t.getElementById("text").text=Bn[e];let n=Bn[e];t.onclick=function(){gt(n)}}at.style.display="inline"}function ht(){clearTimeout(S),S=setTimeout(St,1e4)}function Bt(){if(0==p())return 0;if(p()>40){if(0==p()||(0==ue||p()<ue)&&(0==ge||p()<ge)&&(0==ye||p()>ye)&&(0==ce||p()>ce))return 0;if("inline"==at.style.display)return 0}gn=new Date,"none"!=mn.style.display&&rn(),B.style.fill=Y.setColor(p()),B.style.display="inline",k.style.display="none",w.style.display="none";var e,t=!1;Se(ge)?(e=`BG of ${p()} is higher than urgent high limit of ${ge}`,t=!0):Se(ue)?(e=`BG of ${p()} is higher than high limit of ${ue}`,0==ge&&(t=!0)):De(ce)?(e=`BG of ${p()} is lower than urgent limit of ${ce}`,t=!0):De(ye)&&(e=`BG of ${p()} is lower than limit of ${ye}`,0==ce&&(t=!0)),!t&&In>0?(console.log("setting dismiss function *************"),I.onclick=function(){pt(),gt(In)}):I.onclick=void 0;let n=!1;return!t&&pe&&Ue(Pe,We,gn)||(n=!0),ct.style.display="inline",yt.style.display="inline",$t(e,n),1}var It,bt;function kt(e){It=e,bt=0,wt()}function wt(){r.start("confirmation-max"),bt<It.length&&setTimeout(wt,It[bt++])}yt.onactivate=ft;let Tt=!1;function Et(){gn=new Date,q=t.getElementById("graphWindow"),J=q.getElementById("graphIOB"),K=q.getElementById("graphCOB"),Q=q.getElementById("GraphDismiss"),V=0,Q.onclick=_t,q.style.display="inline",Tt=!0,Y.reset(),te.length>=Y.maxBGs()?Jt(te,ne):(setTimeout(function(){},0),Fe("graph"))}function xt(){V=Bt,Et()}function $t(e,t,n){gn=new Date,console.log(`showmessage - ${e}`),"none"!=mn.style.display&&rn(),""!=e&&(B.style.display="inline",I.text=e,I.style.display="inline"),console.log(`timestamp is ${n}`),void 0!==n?(b.text=n,B.style.fill="white",I.style.fontSize=30,b.style.display="inline",w.style.display="inline",k.style.display="inline"):(b.text=`${gn.getHours()}:${gn.getMinutes()}`,w.style.display="none",I.style.fontSize=40),console.log("Displaying message"),t&&(kt(g),c.poke(),ht())}function vt(e){if(gn=new Date,console.log(`Show alarm ${e}`),-1!=v&&v!=e)return void console.log(`Got alarm ${e}, but already showing ${v}`);if(void 0===T[e])return void console.log("alarm is undefined");if(e<10)T[e].hour,T[e].minute;v=e;let t="<no message>";try{t=i("mess"+e,"json").message}catch(e){}ct.style.display="none",yt.style.display="none",I.onclick=hn>0?function(){jt(),Ht(hn)}:void 0,$t(t,!0,timeStamp)}function St(){"inline"==I.style.display&&(r.start("nudge-max"),c.poke(),ht())}function Dt(e){gn=new Date;let t=new Date;t.setHours(T[e].hour,T[e].minute,0);let n=t.getTime()-gn.getTime();n+=864e5,E[e]=setTimeout(Gt,n,e)}function Gt(e){console.log(`wakeup ********* ${e}`),console.log(`index is ${e}, timeout handle is ${E[e]}`),vt(e),e<10&&Dt(e)}function zt(){gn=new Date;for(let e=0;e<10;e++)x[e]>0&&x[e]-gn.getTime()<0&&(v=e,Qt(2))}function Ct(){gn=new Date,I.style.display="none",B.style.display="none",b.style.display="none",k.style.display="none",w.style.display="none",r.stop(),-1!=v&&(Rt(v),D=v,Pt(v),zt(),v=-1)}function Ht(e){let t=e;console.log(`resetting alarm ${v} for snooze of ${t} mins`),gn=new Date,-1!=v&&(Rt(v),x[v]=gn.getTime()+60*t*1e3,$[v]=setTimeout(Gt,60*t*1e3,v),D=v,Pt(v),zt(),v=-1),Mt.style.display="none",Qe()}let Mt=t.getElementById("snoozeTimes");function Lt(){Ut("note")}function jt(){Zt.style.display="none",on.style.display="none",I.style.display="none",B.style.display="none",b.style.display="none",k.style.display="none",w.style.display="none",clearTimeout(S),r.stop()}function Ut(e){jt();try{let e=i("alarmSnooze","json");for(let t=0;t<8;t++)e[t]&&(fn[t]=e[t])}catch(e){}for(let t=0;t<8;t++){let n=Mt.getElementById(t.toString());n.getElementById("text").text=fn[t];let l=fn[t];switch(e){case"note":n.onclick=function(){Ht(l)};break;case"comm":n.onclick=function(){Nt(l)}}}Mt.style.display="inline"}let At=0;function Nt(e){gn=new Date,At=gn.getTime()+60*e*1e3;new Date(At);o("commsnooze",{time:At},"json"),Mt.style.display="none"}function Rt(e){clearTimeout(S),clearTimeout($[e]),$[e]=0,x[e]=0}function Ot(e,t){if(E[e]&&(clearTimeout(E[e]),v==e&&(Rt(e),v=-1)),void 0===t||""==t||isNaN(parseInt(t))){T[e]=void 0;try{a("note"+e)}catch(e){}}else{{let n=t.split(":");T[e]={hour:n[0],minute:n[1]},gn=new Date;let l=new Date;l.setHours(n[0],n[1],0);let i=l.getTime()-gn.getTime();i<0&&(i+=864e5),E[e]=setTimeout(Gt,i,e)}Pt(e)}}function Pt(e){e>=10&&(T[e]={hour:0,minute:0});try{o("note"+e,{hour:T[e].hour,minute:T[e].minute,snooze:x[e]},"json")}catch(e){}}function Wt(e,t){o("mess"+e,{message:t},"json")}try{let e=i("podchange","json");_e(e.podchange),ke=e.period,we=e.before}catch(e){msg.peerSocket.readyState===msg.peerSocket.OPEN&&msg.peerSocket.send({command:"podchange"})}try{let e=i("BGLimits","json");ce=e.BGUL,ye=e.BGLow,ue=e.BGHigh,ge=e.BGUH,st=e.LS,rt=e.HS,mt=e.ULS,dt=e.UHS,fe=e.BGDiff}catch(e){st=0,rt=0,mt=0,dt=0,ce=0,ye=0,ue=0,ge=0,fe=0}for(let e=0;e<10;e++){gn=new Date;try{let t=i("note"+e,"json");var Ft,Yt;try{let e=t.time;Ft=(e=e.value).hour,Yt=e.minute}catch(e){Ft=t.hour,Yt=t.minute}t.snooze>0&&(t.snooze>gn.getTime()?($[e]=setTimeout(Gt,t.snooze-gn.getTime(),e),x[e]=t.snooze):(v=e,Qt(10))),Ot(e,`${Ft}:${Yt}`)}catch(e){}}function _t(){Tt=!1,q.style.display="none",V&&V()}function qt(e){te=[],ne=[];let t=i(e,"cbor");for(let e=0;e<t.length;e++)te[e]=t[e].s,ne[e]=t[e].d;t=[],Y.updateRgraph(te,ne,z,G,lt),Tt&&Jt(te,ne)}function Jt(e,t){let n=500,l=0;var i,o;let a=q.getElementById("graphMin"),s=q.getElementById("graphMax"),r=q.getElementById("graphMinAt"),m=q.getElementById("graphMaxAt"),d=q.getElementById("graphStartAt"),c=q.getElementById("graphEndAt");var y,u,g;let p,h,B,I,b;try{y=q.getElementById("graphStart"),u=q.getElementById("graphEnd")}catch(e){}L&&(g=q.getElementById("arcIn"),p=q.getElementById("arcAbove"),h=q.getElementById("arcBelow"),B=q.getElementById("timeAbove"),I=q.getElementById("timeIn"),b=q.getElementById("timeBelow"));for(let a=0;a<e.length;a++)e[a]<n&&(n=e[a],i=t[a]),e[a]>l&&(l=e[a],o=t[a]);if(n--,l++,L){let e=0,t=0,i=0;for(let n=0;n<te.length;n++)ue>0&&te[n]>ue?e++:ye>0&&te[n]<ye?t++:i++;e=100*e/te.length,t=100*t/te.length,i=100*i/te.length,B.text=`High: ${util.oneDecimal(e)}%`,I.text=`In: ${util.oneDecimal(i)}%`,b.text=`Low: ${util.oneDecimal(t)}%`,a.text=`Min:${f(n)}`,s.text=`Max:${f(l)}`,g.startAngle=0,g.sweepAngle=360*i/100,g.style.fill=Y.IRC(),p.startAngle=360*i/100,p.sweepAngle=360*e/100,p.style.fill=Y.HC(),h.startAngle=p.startAngle+p.sweepAngle,h.sweepAngle=360*t/100,h.style.fill=Y.LC()}else y.text=Kt(t[t.length-1]),u.text=Kt(t[0]),a.text=`${f(n)}`,s.text=`${f(l)}`;r.text=`${Kt(i)}`,m.text=`${Kt(o)}`,d.text=`Start: ${f(e[e.length-1])}`,c.text=`End: ${f(e[0])}`,J.text="--",K.text="--",Fe("iobcob"),Y.setYRange(n,l),Y.setBGColor("black"),Y.update(e,t,lt),q.style.display="inline"}function Kt(e){let t=new Date(e);return`${t.getHours()}:${util.zeroPad(t.getMinutes())}`}function Qt(e){gn=new Date,-1!=v&&(x[v]-gn.getTime()<=1e3*e&&(x[v]=gn.getTime()+1e3*e),E[v]=setTimeout(Gt,x[v]-gn.getTime(),v))}O.onclick=function(e){V=0,Et()},d.onnewfile=(()=>{let e;do{(e=d.nextFile())&&qt(e)}while(e)});let Vt=t.getElementById("menu"),Xt=Vt.getElementById("menuButton");Xt.onclick=function(){Zt.style.display="inline"};let Zt=t.getElementById("menuWindow1"),en=Zt.getElementsByClassName("menuItem");for(let e=0;e<en.length;e++){let t=Zt.getElementById(e.toString());t.onclick=function(){tn(t.text)}}function tn(e){switch(console.log(`menu id is ${e} lastalarm=${D}`),e){case"Redo last alarm":D>=0&&(E[v=D]=0,x[D]=0,Qt(1)),Zt.style.display="none";break;case"Snooze Comm Warnings":Ut("comm");break;case"Current Suppressions":cn();break;case"Cancel Suppressions":yn();break;case"Reset Interval":dn();break;default:Zt.style.display="none"}}let nn=Zt.getElementById("more");nn.onclick=function(){on.style.display="inline"};let ln=Zt.getElementById("exit");ln.onclick=rn;let on=t.getElementById("menuWindow2");en=on.getElementsByClassName("menuItem");for(let e=0;e<en.length;e++){let t=on.getElementById(e.toString());t.onclick=function(){an(t.text)}}function an(e){switch(e){case"Current Suppressions":cn();break;case"Cancel Suppressions":yn();break;case"Reset Interval":dn();break;default:on.style.display="none"}}en=void 0;try{on.getElementById("more").onclick=function(){}}catch(e){}let sn=on.getElementById("exit");function rn(){B.style.display="none",I.style.display="none",on.style.display="none",Zt.style.display="none",mn.style.display="none"}sn.onclick=rn;let mn=t.getElementById("noticeDismiss");function dn(){msg.peerSocket.send({command:"podreset"}),rn()}function cn(){gn=new Date,I.text="",I.style.fontSize=30,B.style.fill="white";let e=rt-gn.getTime();rt&&e>0&&(I.text=`High BG: ${Math.floor(e/6e4)} mins`);let t=st-gn.getTime();st&&t>0&&(I.text.length>0&&(I.text+="\n"),I.text+=`Low BG: ${Math.floor(t/6e4)} mins`);let n=mt-gn.getTime();mt&&n>0&&(I.text.length>0&&(I.text+="\n"),I.text+=`Urg. Low BG: ${Math.floor(n/6e4)} mins`);let l=dt-gn.getTime();dt&&l>0&&(I.text.length>0&&(I.text+="\n"),I.text+=`Urg. High BG: ${Math.floor(l/6e4)} mins`),At>gn.getTime()&&(I.text.length>0&&(I.text+="\n"),I.text+=`Comm: ${Math.floor((At-gn.getTime())/6e4)} mins`);for(let e=0;e<10;e++)x[e]>0&&(I.text.length>0&&(I.text+="\n"),I.text+=`Alarm ${e+1}: ${Math.floor((x[e]-gn.getTime())/6e4)} mins`);0==I.text.length&&(I.text="No current suppressions"),on.style.display="none",Zt.style.display="none",B.style.display="inline",I.style.display="inline",mn.style.display="inline",mn.onclick=rn}function yn(){rt=0,st=0,dt=0,mt=0,At=0,ut();for(let e=0;e<10;e++)Rt(e),Pt(e);rn(),Qe()}let un=t.getElementById("menu-list"),gn=new Date,pn=gn.getTime();try{let e=i("snooze","json"),t=e.timeout;-1!=e.number&&(t<gn.getTime()&&(t=gn.getTime()+1e4),t>gn.getTime()&&(t-gn.getTime()<=5e3&&(t=gn.getTime()+5e3),$[v]=setTimeout(Gt,t-gn.getTime(),e.number),x[e.number]=t)),a("snooze")}catch(e){}let fn=[10,20,30,40,50,60,90,120],hn=0,Bn=[20,40,60,90,120,180,240,480],In=0;try{Pe=i("warn-start","json")}catch(e){Pe={def:!1}}try{We=i("warn-end","json")}catch(e){We={def:!1}}try{let e=i("commsnooze","json");e&&(At=parseInt(e.time))}catch(e){}try{let e=i("ns","json");Z=e.nsconfigured}catch(e){Z=!1}Z&&setTimeout(Ke,6e4),Ce(),console.log(`model id is ${l.modelId}, name is ${l.modelName}`),c.aodAvailable&&n.permissions.granted("access_aod")&&(console.log("AOD is allowed"),c.aodAllowed=!0);
