import e from"clock";import t from"document";import{me as n}from"appbit";import{me as o}from"device";import*as messaging from"messaging";import*as util from"../common/utils";import{readFileSync as l}from"fs";import{writeFileSync as i}from"fs";import{unlinkSync as a}from"fs";import{statSync as s}from"fs";import{vibration as r}from"haptics";import g from"./graph.js";import{inbox as m}from"file-transfer";import{display as c}from"display";import{memory as d}from"system";import{charger as u}from"power";function y(){return"mmol/L"===K?util.oneDecimal(util.mmol(X)):X}function f(e){return"mmol/L"===K?util.mmol(e):e}function p(e){return"mmol/L"===K?util.mgdl(e):e}d.onmemorypressurechange=function(e){switch(nn.opacity="1",d.pressure){case"normal":nn.fill="green";break;case"high":nn.fill="yellow";break;case"critical":nn.fill="red"}};let h=t.getElementById("noteBG"),$=t.getElementById("noteMess"),w=t.getElementById("noteTime");var b;let v=t.getElementById("dismiss"),B=t.getElementById("snooze");var k=[],x=[],T=[];let I=-1,E=0,S=0,z=-1;o.screen||(o.screen={width:348,height:250});const G=o.screen.width,M=o.screen.height;e.granularity="seconds";import{clockFace as D}from"./clock.js";let H=new D,C=t.getElementById("month"),L=t.getElementById("date"),j=t.getElementById("hour"),N=t.getElementById("minute"),A=t.getElementById("arrow"),U=t.getElementById("circle"),W=t.getElementById("sgv"),R=t.getElementById("state"),P=t.getElementById("forceUpdate"),O=0,F=5;function V(e){let t=new Date;c.on&&_&&J<t.getTime()&&Fe()}P.onclick=function(){_&&Fe()},c.addEventListener("change",V);let _=!1;var q=[];let K="bg/dl",X=0,Y=0,Z=0,J=0,Q=0,ee=0,te=0,ne=0,oe=0,le=40,ie=40,ae=!1,se=0,re=0,ge=0,me=0,ce="",de="",ue="white",ye="",fe="",pe=0,he=0,$e=0,we=0,be=0,ve=3,Be=12;var ke,xe,Te,Ie;function Ee(e){Math.abs(ee)>20||pe>0&&Math.abs(f(ee))>=pe?e.style.fill="red":e.style.fill=Ke?"yellow":"lightgreen"}function Se(){if(me>0&&y()>me){if(""!=fe)return fe}else if(ge>0&&y()>ge){if(""!=ye)return ye}else if(se>0&&y()<se){if(""!=ce)return ce}else if(re>0&&y()<re){if(""!=de)return de}else if(""!=ue)return ue;return"white"}let ze=1*M,Ge=.55*M;function Me(){let e=new Date;if(ke=e.getHours(),xe=e.getMinutes(),Te=e.getDate(),Ie=e.getMonth()+1,u.connected&&c.poke(),H.updateClock(ze,Ge,$e),O>0?(C.text=`${Ie}`,L.text=`${Te}`,j.text=`${ke}`,N.text=`${util.zeroPad(xe)}`,O--):(C.style.display="none",L.style.display="none",j.style.display="none",N.style.display="none",_&&(A.style.display="inline",W.style.display="inline",R.style.display="inline"),tn.style.display="inline"),_&&O<=0){W.text=`${y()}`,W.style.fontSize=le;try{W.style.fill=Se()}catch(e){W.style.fill="white"}let e=(new Date).getTime()-Y,t=1;(e/=6e4)<5?t=1:(e>5&&(e-=5),(t=(20-e)/20)<0&&(t=0),t>1&&(t=1)),W.style.fillOpacity=t,W.style.display="inline",(re||ge||se||me)&&y()>0&&0==t&&(W.style.fillOpacity=1,W.text=`${Math.floor(e)} mins old`);let n=90*ee/20;(n=90-n)<0&&(n=0),n>180&&(n=180),ae?(U.style.display="inline",A.style.display="none",Ee(U)):(U.style.display="none",A.style.display="inline",A.groupTransform.rotate.angle=n,Ee(A),A.style.opacity=t),R.style.fill=je>0?"red":0==je?"green":"white"}}function De(e,t,n){if(!e.defined||!t.defined)return!1;let o=60*e.hours+e.minutes,l=60*t.hours+t.minutes,i=60*n.getHours()+n.getMinutes();if(o==l)return!1;if(o<l){if(o<i&&i<l)return!0}else{if(i>o)return!0;if(i<l)return!0}return!1}function He(e){!De(Ne,Ae,e)&&(0==Gt||Gt<e.getTime())&&(console.log("**** Not in Range"),r.start("nudge-max"),c.poke())}function Ce(e){var t;console.log("Looking for forceExit file");try{s("forceExit");t=!0}catch(e){t=!1}if(console.log(`Found exited to be set as ${t}`),t)He(e);else{i("forceExit",{time:e},"json");let t=s("forceExit");console.log(`forceexit file info ${t}`),n.exit()}}let Le=0,je=-1,Ne={defined:!1},Ae={defined:!1};function Ue(e){var t;let n=new Date;return messaging.peerSocket.readyState===messaging.peerSocket.OPEN?(messaging.peerSocket.send({command:e}),Le=n.getTime(),je<0?je--:je=-1,t=!0):(je>0?je++:je=1,t=!1),Math.abs(je)>10&&(re>0||ge>0||se>0||me>0)&&Ce(n),t}var We=t.getElementById("clicker");function Re(e){let t=new Date(e);if(null==e||isNaN(e))return $e=0,we=0,void(be=0);$e=new Date(t.getTime()+24*ve*60*60*1e3-60*Be*60*1e3),console.log(`New comet time of ${$e}`),we=$e.getHours(),be=$e.getMinutes()}We.onclick=function(e){console.log("click"),0==O?(C.text=`${Ie}`,L.text=`${Te}`,j.text=`${ke}`,N.text=`${xe}`,C.style.display="inline",L.style.display="inline",j.style.display="inline",N.style.display="inline",A.style.display="none",W.style.display="none",R.style.display="none",U.style.display="none",tn.style.display="none",O=F):O=0},e.ontick=(()=>Me());let Pe=0;function Oe(){clearTimeout(Pe),console.log("fetching again due to no ack"),Fe()}function Fe(){_&&(console.log("Wakeup and fetch data"),Ue("data")?(Pe&&clearTimeout(Pe),Pe=setTimeout(Oe,5e3)):(he&&clearTimeout(he),he=setTimeout(Fe,1e4)))}function Ve(){console.log("testlimits..."),console.log(`bgValue is ${y()} BGLow is ${re}`),(re||ge||se||me)&&(ge>0&&y()>ge||re>0&&y()<re||me>0&&y()>me||se>0&&y()<se?pt():(yt(),"inline"==mt.style.display&&yt(),"inline"==ot.style.display&&(ot.style.display="none"),"inline"==Lt.style.display&&Xt==pt&&Yt()))}let _e=0,qe=0,Ke=!1;function Xe(e){if(Ke=!1,0==_e||0==qe)return;var t;let n=util.Min2ms(_e);for(t=0;t<q.length&&e.getTime()-q[t].date<n;t++)if(q.cal)return;if(!(--t<=0))try{new Date(q[t].date);Math.abs(y()-f(q[t].sgv))>qe&&(Ke=!0,He(e))}catch(e){}}function Ye(e){1==e?(0==_&&(console.log("ns switching from false to true"),_=!0,Fe()),P.style.display="inline",R.style.display="inline",q.length<24&&(console.log("Fetching initial graph data"),Ue("graph"))):(_=!1,A.style.display="none",W.style.display="none",R.style.display="none",P.style.display="none",U.style.display="none"),console.log(`nsConfigured = ${_}`)}messaging.peerSocket.onmessage=(e=>{let t=new Date;switch(console.log("message for you, sir! "+e.data.key),e.data.key){case"bg":je=0,console.log(`bgVal=${e.data.bg}`),console.log(`bgDate=${e.data.date}`),console.log(`bgPeriod=${e.data.period}`),console.log(`bgDelta=${e.data.delta}`),console.log(`nextUpdate=${(e.data.update-t.getTime())/6e4} mins`),console.log(`calibration=${e.data.calibration}`);let o=t.getTime()-e.data.date;if(console.log(`bgAge = ${o} = ${o/6e4} mins`),e.data.bg>0)for(X=e.data.bg,Y=e.data.date,t.getTime()-Y>=util.Min2ms(20)&&(re||ge||se||me)&&He(t),Z=e.data.period,ee=e.data.delta,ae=e.data.calibration,Ve(),q.unshift({sgv:X,date:Y,cal:ae}),console.log(`BG length = ${q.length}`);q.length>24;)q.pop();if(e.data.update>0){J=e.data.update,console.log(`Setting wakeup for ${J-t.getTime()} ms`);let n=new Date(J);console.log(`at: ${n}`),he&&clearTimeout(he),he=setTimeout(Fe,J-t.getTime()),Q=J-t.getTime(),te=t.getTime()}var n;isNaN(ee)&&(delta=0),ae?(console.log("calibration"),n||He(t),n=!0):(n=!1,pe>0&&Math.abs(f(ee))>=pe?He(t):Xe(t)),ht&&Jt(q),Ye(1);break;case"ack":console.log("Received ACK"),je=0,Pe&&(clearTimeout(Pe),Pe=0);break;case"podchange":console.log(`evt.data.value=${e.data.value}`);let l=parseInt(e.data.value);ve=parseInt(e.data.period),Be=parseInt(e.data.before),console.log(`p=${e.data.value}`),Re(l),i("podchange",{podchange:l,period:ve,before:Be},"json");break;case"alarm":console.log(`received alarm ${e.data.number} as ${e.data.value}`),Dt(e.data.number,e.data.value);break;case"mess":console.log(`received mess ${e.data.number} as ${e.data.value}`),Ht(e.data.number,e.data.value);break;case"alarmsnooze":console.log(`alarmsnoozetimes ${e.data.number} = ${e.data.value}`),bn[e.data.number]=parseInt(e.data.value),i("alarmSnooze",bn,"json");break;case"timer":console.log(`Received timer request for ${e.data.number} minutes`),nt(e.data.number);break;case"limits":se=e.data.urgentLow,re=e.data.low,ge=e.data.high,me=e.data.urgentHigh,pe=e.data.diff,ce=e.data.urgentLowColor,de=e.data.lowColor,ue=e.data.inRangeColor,ye=e.data.highColor,fe=e.data.urgentHighColor,dt(),Ve();break;case"long":_e=e.data.period,qe=e.data.diff;break;case"warn-start":if(""==e.data.value)Ne={defined:!1};else{let t=e.data.value.split(":");Ne={hours:parseInt(t[0]),minutes:parseInt(t[1]),defined:!0}}i("warn-start",Ne,"json"),console.log(`Warn-start: ${Ne.hours}:${Ne.minutes}`);break;case"warn-end":if(""==e.data.value)Ae={defined:!1};else{let t=e.data.value.split(":");Ae={hours:parseInt(t[0]),minutes:parseInt(t[1]),defined:!0}}i("warn-end",Ae,"json"),console.log(`Warn-end: ${Ae.hours}:${Ae.minutes}`);break;case"units":K=e.data.value,console.log(`Got new Units of ${K}`),Ve();break;case"bgFont1":le=e.data.number;break;case"bgsnooze":console.log(`bgsnooze ${e.data.number} = ${e.data.value}`),vn[e.data.number]=parseInt(e.data.value),i("BGSnooze",vn,"json");break;case"ns":i("ns",{nsconfigured:e.data.number},"json"),Ye(e.data.number);break;case"graphdata":q=e.data.data,ht&&Jt(q);break;case"gradient":H.setGradColor(e.data.value);break;case"hour":H.setHourColor(e.data.value);break;case"minute":H.setMinColor(e.data.value);break;case"second":H.setSecColor(e.data.value);break;case"iobcob":ne=e.data.iob,oe=e.data.cob,_t.text=`${ne}`,qt.text=`${oe}`}try{a("forceExit")}catch(e){}});let Ze=t.getElementById("timerWindow"),Je=Ze.getElementById("timer"),Qe=0,et=0;function tt(){console.log(`TimerCallback here countdown is ${et}`);let e=Math.floor(et/60),t=et-60*e;Je.text=`${util.zeroPad(e)}:${util.zeroPad(t)}`,--et<0?(et=0,clearInterval(Qe),Ze.style.display="none",console.log("timer end"),r.start("nudge-max")):et<5&&(console.log("timer last values"),r.start("bump")),c.poke()}function nt(e){console.log(`starting timer with value ${e}`),Ze.style.display="inline",et=60*e,Qe=setInterval(tt,1e3)}messaging.peerSocket.onopen=(e=>{console.log("Watch is ready"),_&&Fe()});let ot=t.getElementById("snoozeBGTimes");var lt=[];for(let e=0;e<8;e++)lt[e]=ot.getElementById(e.toString());let it=0,at=0,st=0,rt=0,gt=0,mt=t.getElementById("BGgraph"),ct=t.getElementById("suppress");function dt(){i("BGLimits",{BGUrgentLow:se,BGLow:re,BGHigh:ge,BGUrgentHigh:me,lowSnooze:at,highSnooze:st,urgentLowSnooze:rt,urgentHighSnooze:gt,BGDiff:pe},"json")}function ut(e){console.log(`BG Snooze for ${e} minutes`),ot.style.display="none";let t=new Date;se>0&&y()<se?rt=t.getTime()+6e4*e:me>0&&y()>me?gt=t.getTime()+6e4*e:ge>0&&y()>ge?st=t.getTime()+6e4*e:re>0&&y()<re&&(at=t.getTime()+6e4*e),dt()}function yt(){$.style.display="none",$.style.fill="black",h.style.display="none",w.style.display="none",ct.style.display="none",mt.style.display="none",r.stop(),clearTimeout(it),en(2)}function ft(){console.log("Snooze BG"),yt();for(let e=0;e<8;e++)lt[e].getElementById("text").text=vn[e],lt[e].onclick=function(){ut(vn[e])};ot.style.display="inline"}function pt(){if(0==y()||(0==ge||y()<ge)&&(0==me||y()<me)&&(0==re||y()>re)&&(0==se||y()>se))return;if("inline"==ot.style.display)return;let e=new Date;if(!(ge>0&&y()>ge&&e.getTime()<st||me>0&&y()>me&&e.getTime()<gt||re>0&&y()<re&&e.getTime()<at||se>0&&y()<se&&e.getTime()<rt)){try{h.style.fill=Se()}catch(e){h.style.fill="white"}h.style.display="inline",v.style.display="none",B.style.display="none",w.text=`${e.getHours()}:${util.zeroPad(e.getMinutes())}`,w.style.display="inline",me>0&&y()>me?$.text=`BG of ${y()} is higher than urgent high limit of ${me}`:ge>0&&y()>ge?$.text=`BG of ${y()} is higher than high limit of ${ge}`:se>0&&y()<se?$.text=`BG of ${y()} is lower than urgent limit of ${se}`:re>0&&y()<re&&($.text=`BG of ${y()} is lower than limit of ${re}`),$.style.display="inline",$.style.fill="black",$.style.fontSize=50,console.log("warnBG"),r.start("nudge-max"),c.poke(),it=setTimeout(pt,1e4),mt.onactivate=wt,mt.style.fill="black",mt.style.display="inline",ct.style.fill="black",ct.style.display="inline",ct.onactivate=ft}}let ht=!1;function $t(){console.log("displayGraph"),ht=!0,q.length>=24?(console.log("length=24"),Nt.reset(),console.log("updating graph"),Jt(q)):(console.log("getting data"),Nt.reset(),console.log(`Getting graph data because we don't have enough - length=${q.length}`),Ue("graph"))}function wt(){Xt=pt,Lt.style.display="inline",$t()}function bt(e){let t=new Date;I=e,h.style.display="inline",h.style.fill="white",w.text=`${k[e].value.hour}:${k[e].value.minute}`,w.style.display="inline",v.style.fill="black",v.style.display="inline",B.style.fill="black",B.style.display="inline",v.onactivate=xt,B.onactivate=St,void 0===x[e]||""==x[e].value?$.text="<no text>":$.text=x[e].value,$.style.fill="black",$.style.display="inline",$.style.fontSize=40,r.start("nudge-max"),c.poke(),S=setTimeout(vt,1e4),i("snooze",{number:I,timeout:t.getTime(),last:I},"json")}function vt(){"inline"==$.style.display&&-1!=I&&(r.start("nudge-max"),c.poke(),S=setTimeout(vt,1e4))}function Bt(e){let t=new Date,n=new Date;n.setHours(k[e].value.hour,k[e].value.minute,0);let o=n.getTime()-t.getTime();o+=util.Hour2ms(24),console.log(`Resetting timeout in ${o} ms`),T[e]=setTimeout(kt,o),E=t.getTime()+o}function kt(e){if(console.log("wakeup ********* "),console.log(`currAlarm=${I}, timeout handle is ${T[I]}`),I>=0&&T[I]>=0)return void bt(I);let t=new Date;for(let e=0;e<k.length;e++)if(k[e]&&k[e].value.hour==t.getHours()&&k[e].value.minute==t.getMinutes())return I=e,bt(e),void Bt(e)}function xt(){console.log("Dismiss"),$.style.display="none",h.style.display="none",w.style.display="none",v.style.display="none",B.style.display="none",r.stop(),clearTimeout(S),E=0,z=I,i("snooze",{number:I=-1,timeout:0,last:z},"json")}function Tt(e){console.log(`selected ${e}`);let t=e;console.log(`resetting alarm for snooze of ${t} mins`);let n=new Date;E=n.getTime()+util.Min2ms(t),S=setTimeout(kt,util.Min2ms(t)),console.log(`curr Timeout Handle = ${T[I]}`),console.log(`currAlarm=${I}`),i("snooze",{number:I,timeout:E,last:z=I},"json"),It.style.display="none"}let It=t.getElementById("snoozeTimes");var Et=[];for(let e=0;e<8;e++)Et[e]=It.getElementById(e.toString());function St(){zt("BG")}function zt(e){switch(console.log("Snooze"),e){case"BG":clearTimeout(S),E=-1,r.stop(),$.style.display="none",h.style.display="none",w.style.display="none",v.style.display="none",B.style.display="none";break;case"comm":on.style.display="none"}for(let t=0;t<8;t++)switch(Et[t].getElementById("text").text=bn[t],e){case"BG":Et[t].onclick=function(){Tt(bn[t])};break;case"comm":Et[t].onclick=function(){Mt(bn[t])}}It.style.display="inline"}let Gt=0;function Mt(e){now=new Date,console.log(`commSnooze time is ${e}`),Gt=now.getTime()+util.Min2ms(e);let t=new Date(Gt);console.log(`ending comm snooze at ${t}`),i("commsnooze",{time:Gt},"json"),It.style.display="none",console.log(`lastalarm=${z}`)}function Dt(e,t){if(console.log(`setting alarm ${e} to ${t}`),T[e]&&(clearTimeout(T[e]),I==e&&(clearTimeout(S),E=0,I=-1)),void 0===t||""==t||isNaN(parseInt(t))){console.log(`clearing alarm num ${e}`);try{a("note"+e)}catch(e){}}else{{let n=t.split(":");k[e]={name:"alarm"+e.toString(),value:{hour:n[0],minute:n[1]}},console.log(`alarm value is ${k[e].value.hour}:${k[e].value.minute}`);let o=new Date,l=new Date;l.setHours(n[0],n[1],0);let i=l.getTime()-o.getTime();i<0&&(i+=util.Hour2ms(24),console.log("Setting alarm for tomorrow")),console.log(`setting alarm to ${i} ms`),T[e]=setTimeout(kt,i),E=o.getTime()+i}void 0===x[e]||""==x[e].value?Ht(e,""):i("note"+e,{time:k[e],message:x[e]},"json")}}function Ht(e,t){console.log(`setting message ${e} to ${t}`),x[e]={name:"message"+e.toString(),value:t},i("note"+e,{time:k[e],message:x[e]},"json")}let Ct=new ArrayBuffer(50);console.log("trying to read podchange info");try{Ct=l("podchange","json"),console.log(`podchange = ${Ct.podchange}`),Re(Ct.podchange),ve=Ct.period,Be=Ct.before}catch(e){console.log("no podchange info - asking companion"),messaging.peerSocket.readyState===messaging.peerSocket.OPEN&&messaging.peerSocket.send({command:"podchange"})}try{Ct=l("BGLimits","json"),se=Ct.BGUrgentLow,re=Ct.BGLow,ge=Ct.BGHigh,me=Ct.BGUrgentHigh,at=Ct.lowSnooze,st=Ct.highSnooze,rt=Ct.urgentLowSnooze,gt=Ct.urgentHighSnooze,pe=Ct.BGDiff}catch(e){at=0,st=0,rt=0,gt=0,se=0,re=0,ge=0,me=0,pe=0}for(let e=0;e<10;e++){let t=new ArrayBuffer(200),n=new Date;try{t=l("note"+e,"json"),console.log(`read note ${e}, m=${t}`);let o="";if(void 0===t.message||void 0===t.message.value?(console.log("setting message to null"),o=""):(console.log("setting message to something"),o=t.message.value),t&&!isNaN(t.time.value.hour)&&!isNaN(t.time.value.minute)){console.log(`i=${e}: m=${t.time.value.hour}:${t.time.value.minute} , ${o}`),k[e]=t.time,x[e]={value:o};let l=new Date;l.setHours(t.time.value.hour,t.time.value.minute,0);let i=l.getTime()-n.getTime();i<0&&(i+=util.Hour2ms(24)),console.log(`Setting timeout in ${i} ms`),T[e]=setTimeout(kt,i),E=n.getTime()+i}}catch(e){}}let Lt=t.getElementById("graphWindow"),jt=Lt.getElementById("docGraph");var Nt=new g(jt);let At=Lt.getElementById("graphMin"),Ut=Lt.getElementById("graphMax"),Wt=Lt.getElementById("graphStart"),Rt=Lt.getElementById("graphEnd"),Pt=Lt.getElementById("graphMinAt"),Ot=Lt.getElementById("graphMaxAt"),Ft=Lt.getElementById("graphStartAt"),Vt=Lt.getElementById("graphEndAt"),_t=Lt.getElementById("graphIOB"),qt=Lt.getElementById("graphCOB"),Kt=Lt.getElementById("GraphDismiss"),Xt=0;function Yt(){ht=!1,Lt.style.display="none",Xt&&Xt()}function Zt(e){q=l(e,"cbor"),ht&&Jt(q)}function Jt(e){let t=500,n=0;var o,l;for(let i=0;i<e.length;i++)e[i].sgv<t&&(t=e[i].sgv,o=e[i].date),e[i].sgv>n&&(n=e[i].sgv,l=e[i].date);t--,n++,console.log(`min=${t} max=${n}`),Wt.text=Qt(e[e.length-1].date),Rt.text=Qt(e[0].date),At.text=`${f(t)}`,Ut.text=`${f(n)}`,Pt.text=`${Qt(o)}`,Ot.text=`${Qt(l)}`,Ft.text=`Start: ${f(e[e.length-1].sgv)}`,Vt.text=`End: ${f(e[0].sgv)}`,_t.text="--",qt.text="--",Ue("iobcob"),Nt.setYRange(t,n),Nt.setUrgentLowLimit(p(se)),Nt.setLowLimit(p(re)),Nt.setHighLimit(p(ge)),Nt.setUrgentHighLimit(p(me)),Nt.setBGColor("black"),Nt.setUrgentLowColor(ce),Nt.setLowColor(de),Nt.setUrgentHighColor(fe),Nt.setHighColor(ye),Nt.setInRangeColor(ue),Nt.update(e)}function Qt(e){let t=new Date(e);return`${t.getHours()}:${util.zeroPad(t.getMinutes())}`}function en(e){let t=new Date;-1!=I&&(E-t.getTime()<=1e3*e&&(E=t.getTime()+1e3*e),T[I]=setTimeout(kt,E-t.getTime()))}Kt.onclick=Yt,W.onclick=function(e){console.log("click on sgv"),Lt.style.display="inline",Xt=0,console.log("setting high low"),Nt.setHigh=ge,Nt.setLow=re,console.log("done setting"),$t()},m.onnewfile=(()=>{let e;do{(e=m.nextFile())&&(console.log(`Got info: ${e}`),Zt(e))}while(e)});let tn=t.getElementById("menu"),nn=tn.getElementById("menuButton");nn.onclick=function(){console.log("MENU!"),on.style.display="inline"};let on=t.getElementById("menuWindow1"),ln=on.getElementById("more"),an=on.getElementById("exit");var sn=[];let rn=on.getElementsByClassName("menuItem");for(let e=0;e<rn.length;e++)sn[e]=on.getElementById(e.toString()),sn[e].onclick=function(){gn(sn[e].text)};function gn(e){switch(console.log(`string is ${e} lastalarm=${z}`),e){case"Redo last alarm":z>=0&&(I=z,console.log(`Redo alarm ${z}`),T[I]=0,E=0,en(1)),on.style.display="none";break;case"Snooze Comm Warnings":zt("comm");break;case"Current Suppressions":hn();break;case"Cancel Suppressions":$n();break;default:on.style.display="none"}}null!=ln&&(ln.onclick=function(){console.log("more1"),mn.style.display="inline"}),an.onclick=fn;let mn=t.getElementById("menuWindow2"),cn=mn.getElementById("more"),dn=mn.getElementById("exit");var un=[];rn=mn.getElementsByClassName("menuItem");for(let e=0;e<rn.length;e++)un[e]=mn.getElementById(e.toString()),un[e].onclick=function(){yn(un[e].text)};function yn(e){switch(e){case"Current Suppressions":hn();break;case"Cancel Suppressions":$n();break;default:mn.style.display="none"}}function fn(){console.log("exit menu"),h.style.display="none",$.style.display="none",mn.style.display="none",on.style.display="none",pn.style.display="none"}null!=cn&&(cn.onclick=function(){console.log("more2")}),dn.onclick=fn;let pn=t.getElementById("noticeDismiss");function hn(){console.log("Suppressions Text");let e=!1,t=new Date;$.text="";let n=st-t.getTime();st&&n>0&&($.text=`High BG: ${Math.floor(n/6e4)} mins`,e=!0);let o=at-t.getTime();at&&o>0&&(""!=$.text&&(noteMesa.text+="\n"),$.text=`Low BG: ${Math.floor(o/6e4)} mins`,e=!0);let l=rt-t.getTime();rt&&lowUrgentBGSuppress>0&&(""!=$.text&&(noteMesa.text+="\n"),$.text=`Low BG: ${Math.floor(l/6e4)} mins`,e=!0);let i=gt-t.getTime();gt&&urgentHighGSuppress>0&&(""!=$.text&&(noteMesa.text+="\n"),$.text=`Low BG: ${Math.floor(i/6e4)} mins`,e=!0),Gt>t.getTime()&&(""!=$.text&&($.text+="\n"),$.text+=`Comm: ${Math.floor((Gt-t.getTime())/6e4)} mins`,e=!0),I>=0&&S&&(""!=$.text&&($.text+="\n"),console.log(`currSnooze=${E}, currAlarm=${I}`),$.text+=`Alarm ${I+1}: ${Math.floor((E-t.getTime())/6e4)} mins`,e=!0),e||(console.log("nothing to show"),$.text="No current suppressions"),mn.style.display="none",on.style.display="none",h.style.display="inline",$.style.display="inline",pn.style.display="inline",pn.onclick=fn}function $n(){st=0,at=0,gt=0,rt=0,Gt=0,fn()}let wn=t.getElementById("menu-list");try{let e=new Date;Ct=l("snooze","json"),console.log(`reading snooze data: ${Ct.timeout-e.getTime()} ms`),I=Ct.number;let t=Ct.timeout;-1!=I&&(t>e.getTime()?(t-e.getTime()<=5e3&&(t=e.getTime()+5e3),T[I]=setTimeout(kt,t-e.getTime()),E=t,console.log(`Reestablishing snooze for ${I} in ${t-e.getTime()} ms`)):(console.log("Were snoozing when we exited - rescheduling for now"),E=t,en(2))),z=Ct.last}catch(e){}let bn=[10,20,30,40,50,60,90,120];try{Ct=l("alarmSnooze","json");for(let e=0;e<8;e++)Ct[e]&&(bn[e]=Ct[e])}catch(e){}let vn=[20,40,60,90,120,180,240,480];try{Ct=l("BGSnooze","json");for(let e=0;e<8;e++)Ct[e]&&(vn[e]=Ct[e])}catch(e){}try{new Date;let e=l("warn-start","json");Ne.hours=parseInt(e.hours),Ne.minutes=parseInt(e.minutes),Ne.defined=!0,console.log(`Warn-start: ${Ne.hours}:${Ne.minutes}`)}catch(e){Ne={defined:!1}}try{new Date;let e=l("warn-end","json");Ae.hours=parseInt(e.hours),Ae.minutes=parseInt(e.minutes),Ae.defined=!0,console.log(`Warn-end: ${Ae.hours}:${Ae.minutes}`)}catch(e){Ae={defined:!1}}try{let e=l("commsnooze","json");e&&(Gt=parseInt(e.time),console.log(`commSnoozeEnd=${Gt}`))}catch(e){}try{Ct=l("ns","json"),_=Ct.nsconfigured}catch(e){_=!1}_&&setTimeout(Fe,util.Min2ms(1)),console.log(`max. message size is ${messaging.peerSocket.MAX_MESSAGE_SIZE}`);
